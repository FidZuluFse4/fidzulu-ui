<!-- Main loading spinner -->
<div *ngIf="isLoading" class="loading-container">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Loading products...</p>
</div>

<div *ngIf="!isLoading" class="product-grid-container">
  <!-- Currency is auto-selected based on the Address selected in the header; manual selector removed -->
  <mat-card
    class="product-card"
    *ngFor="let product of products; trackBy: trackByProductId"
    (click)="goToProductDetails(product.p_id)"
  >
    <div class="card-image-container">
      <img
        mat-card-image
        [src]="product.p_img_url"
        [alt]="product.p_name"
        [title]="product.p_name"
      />
      <button
        class="wishlist-heart"
        (click)="$event.stopPropagation(); addToWishlist(product)"
        [disabled]="isWishlistLoading[product.p_id]"
      >
        <mat-spinner
          *ngIf="isWishlistLoading[product.p_id]"
          class="heart-spinner"
          diameter="20"
        >
        </mat-spinner>
        <mat-icon
          *ngIf="!isWishlistLoading[product.p_id]"
          class="wishlist-icon"
          >{{
            wishlistIds.has(product.p_id) ? "favorite" : "favorite_border"
          }}</mat-icon
        >
      </button>
    </div>

    <mat-card-content>
      <div class="brand-name">{{ product.p_subtype }}</div>
      <div class="product-name">{{ product.p_name }}</div>
      <div class="product-price">
        {{ product.p_currency }} {{ product.p_price | number : "1.0-2" }}
      </div>
    </mat-card-content>

    <mat-card-actions (click)="$event.stopPropagation()">
      <!-- Show Add to Cart only if quantity is 0 -->
      <button
        mat-flat-button
        color="primary"
        class="add-to-cart-btn"
        *ngIf="!getQuantity(product)"
        (click)="addToCart(product)"
        [disabled]="isCartLoading[product.p_id]"
      >
        <mat-spinner
          *ngIf="isCartLoading[product.p_id]"
          class="button-spinner"
          diameter="20"
        >
        </mat-spinner>
        <span *ngIf="!isCartLoading[product.p_id]">
          <mat-icon>add_shopping_cart</mat-icon>
          Add to Cart
        </span>
      </button>

      <!-- Show quantity selector if product added -->
      <div class="qty-selector" *ngIf="getQuantity(product)">
        <button
          mat-mini-button
          (click)="decreaseQuantity(product)"
          [disabled]="isCartLoading[product.p_id]"
        >
          âˆ’
        </button>
        <label [attr.for]="'qty-' + product.p_id" class="visually-hidden"
          >Quantity for {{ product.p_name }}</label
        >
        <div class="qty-input-container">
          <mat-spinner
            *ngIf="isCartLoading[product.p_id]"
            class="qty-spinner"
            diameter="16"
          >
          </mat-spinner>
          <input
            *ngIf="!isCartLoading[product.p_id]"
            id="{{ 'qty-' + product.p_id }}"
            readonly
            [value]="getQuantity(product)"
            placeholder="Qty"
            [attr.aria-label]="'Quantity for ' + product.p_name"
            [title]="'Quantity for ' + product.p_name"
          />
        </div>
        <button
          mat-mini-button
          (click)="increaseQuantity(product)"
          [disabled]="isCartLoading[product.p_id]"
        >
          +
        </button>
      </div>
    </mat-card-actions>
  </mat-card>
</div>
